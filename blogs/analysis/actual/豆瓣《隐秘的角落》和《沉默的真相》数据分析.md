---
title: 豆瓣《隐秘的角落》和《沉默的真相》数据分析.
date: 2020-09-06
draft: false
tags: ["requests","pandas"]
categories: ["分析实战"]
---

最近有两部国产剧比较火，一部是《隐秘的角落》和正在热播的《沉默的真相》

对于这两部剧，网友评价都挺高，豆瓣评分都在9分左右，可见颇受欢迎

![隐秘的角落评分](/images/202009/22/隐秘的角落评分.jpg)

![沉默的真相评分](/images/202009/22/沉默的真相评分.jpg)

接下来就网友对这两部剧的评论和看法，进行简单的分析

## 数据获取

首先从豆瓣评论页面后台入口抓取网友的评论信息

隐秘的角落：`https://movie.douban.com/subject/33404425/comments?start=20&limit=20&sort=new_score&status=P&comments_only=1`

沉默的真相： `https://movie.douban.com/subject/33447642/comments?start=20&limit=20&sort=new_score&status=P&comments_only=1`

其实更改ID就可以了，其他信息是一样的

完整代码如下：

```python
import time
import json
import shutil
import random
import requests
import re,os,csv
import traceback
import pandas as pd
from loguru import logger
from parsel import Selector
from dataclasses import dataclass
from copyheaders import headers_raw_to_dict
session=requests.Session()
requests.packages.urllib3.disable_warnings()

@dataclass
class Spider(object):
    sku = os.path.splitext(os.path.basename(__file__))[0]
    r_h=b'''
    Cookie: ll="118282"; bid=Y4AaDkvtfWE; push_doumail_num=0; _vwo_uuid_v2=D2D3B78CE0D3669489E8C20AD4EBECC14|3133ccb1635f05428c1b1e0aa53ba021; gr_user_id=1514c998-7897-4978-b145-e5b90b112d79; douban-fav-remind=1; __gads=ID=f6bc8931e52455db:T=1589027862:S=ALNI_Mbiipw8JRVJFHZgcpqW7GHkJhKfag; douban-profile-remind=1; __utmv=30149280.14155; viewed="34463395"; dbcl2="141551961:36mixJxHsb4"; ck=OczH; ap_v=0,6.0; __utmc=30149280; __utmc=223695111; push_noty_num=0; __utma=30149280.1305261876.1596342801.1600747028.1600750987.35; __utmz=30149280.1600750987.35.13.utmcsr=movie.douban.com|utmccn=(referral)|utmcmd=referral|utmcct=/subject/33447642/comments; __utmt=1; __utma=223695111.1437118223.1587289374.1600747028.1600750990.42; __utmb=223695111.0.10.1600750990; __utmz=223695111.1600750990.42.32.utmcsr=search.douban.com|utmccn=(referral)|utmcmd=referral|utmcct=/movie/subject_search; _pk_ref.100001.4cf6=%5B%22%22%2C%22%22%2C1600750990%2C%22https%3A%2F%2Fsearch.douban.com%2Fmovie%2Fsubject_search%3Fsearch_text%3D%25E6%25B2%2589%25E9%25BB%2598%25E7%259A%2584%25E7%259C%259F%25E7%259B%25B8%26cat%3D1002%22%5D; _pk_ses.100001.4cf6=*; __utmb=30149280.4.10.1600750987; _pk_id.100001.4cf6=d7da5ff658f558d0.1587289375.42.1600751423.1600748446.
    Host: movie.douban.com
    User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.102 Safari/537.36
    X-Requested-With: XMLHttpRequest
    '''
    headers=headers_raw_to_dict(r_h)
    data_list = []
    #这里遍历两部剧的ID：[33404425,33447642]
    base_url='https://movie.douban.com/subject/33404425/comments?start={}&limit=20&sort=new_score&status=P&comments_only=1'
    keys=['id', 'name','rating','time','content']

    def get_movie(self):
        try:
            for page in range(0,500,20): #每个页面有20条评论，一共有24页
                resp=session.get(url=self.base_url.format(page),headers=self.headers,verify=False).json()['html']
                sel=Selector(resp)
                all_div=sel.xpath("//div[@class='comment-item']")
                for i in all_div:
                    id=i.xpath("./@data-cid").get()
                    name=i.xpath(".//span[@class='comment-info']/a/text()").get()
                    rating=i.xpath(".//span[@class='comment-info']/span[2]/@title").get()
                    t=i.xpath(".//span[@class='comment-info']/span[3]/text()").get()
                    content=i.xpath(".//span[@class='short']/text()").get()
                    result=id,name,rating,t,content
                    self.data_list.append(result)
                    logger.info(result)
                time.sleep(random.random()*2+1)         
        except Exception:
            traceback.print_exc()

    def save_data(self):
        all_data=sorted(list(set(self.data_list)),key=self.data_list.index)
        data = pd.DataFrame(all_data,columns=[h.title() for h in self.keys])
        dirname=time.strftime("%Y%m%d",time.localtime())
        os.makedirs(dirname,exist_ok=True)
        skufile='./{0}/'.format(dirname)+self.sku+dirname
        os.makedirs(skufile,exist_ok=True)
        shutil.copy(self.sku+'.py',skufile+'/'+self.sku+'.py')
        data.to_excel(skufile+'/{0}{1}.xlsx'.format(self.sku,dirname),index=False)
        logger.info("data saved successfully")

    def start(self):
        self.get_movie()
        self.save_data()

if __name__=='__main__':
    Spider().start()
```

## 分词

数据抓取下来后，对评论信息进行分词处理

```python
import pandas as pd

data=pd.read_excel("data.xlsx")

txt = data['Content'].str.cat(sep='。')

# 文本预处理  去除一些无用的字符   只提取出中文出来
new_data = re.findall('[\u4e00-\u9fa5]+', txt, re.S)  # 只要字符串中的中文
new_data = " ".join(new_data)

# 文本分词--精确模式
seg_list_exact = jieba.cut(new_data, cut_all=False)

result_list = []
with open('stop_words.txt', encoding='utf-8') as f:
    con = f.readlines()
    stop_words = set()
    for i in con:
        i = i.replace("\n", "")   # 去掉读取每一行数据的\n
        stop_words.add(i)

for word in seg_list_exact:
    # 设置停用词并去除单个词
    if word not in stop_words and len(word) > 1:
        result_list.append(word)
# print(result_list)

# 筛选后统计
word_counts = collections.Counter(result_list)
# 获取前100最高频的词
word_counts_top100 = word_counts.most_common(100)
# 打印出来看看统计的词频
# print(word_counts_top100)
```

## 词云图

最后进行词云图展示

```python
# 链式调用
c = (
    WordCloud(
        init_opts=opts.InitOpts(width='1000px', height='750px')
    )
    .add(
        series_name="词频",               # 系列名称
        data_pair=word_counts_top100,   # 系列数据项 [(word1, count1), (word2, count2)]
        word_size_range=[15, 108],      # 单词字体大小范围
        textstyle_opts=opts.TextStyleOpts(     # 词云图文字的配置
            font_family='KaiTi',
        ),
        shape=SymbolType.DIAMOND,  # 词云图轮廓，有 'circle', 'cardioid', 'diamond', 'triangle-forward', 'triangle', 'pentagon', 'star' 可选
        pos_left='100',  # 距离左侧的距离
        pos_top='50',    # 距离顶部的距离
    )
    .set_global_opts(
        title_opts=opts.TitleOpts(           # 标题配置项
            title='《隐秘的角落》词云图', #分别对两部剧进行词云图展示
            title_textstyle_opts=opts.TextStyleOpts(
                font_family='SimHei',
                font_size=25,
                color='black'
            ),
#             pos_left='500',
            pos_top='10',
        ),
        tooltip_opts=opts.TooltipOpts(       # 提示框配置项
            is_show=True,
            background_color='red',
            border_color='yellow',
        ),
        toolbox_opts=opts.ToolboxOpts(       # 工具箱配置项
            is_show=True,
            orient='vertical',
        )
    )
#     .render('词云图2.html')
)
c.render_notebook()
```

![隐秘的角落](/images/202009/22/隐秘的角落词云图.jpg)

![沉默的真相词云图](/images/202009/22/沉默的真相词云图.png)